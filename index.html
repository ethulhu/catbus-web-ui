<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>home</title>
	<style>
	@media (prefers-color-scheme: dark) {
		body {
			background: #1f1f1f;
			color: #ddd;
		}
		label {
			display: block;
		}
	}
	</style>
	<script src='./paho-mqtt.js' type='text/javascript'></script>
</head>
<body>
	<h1>edelheim</h1>
	<main id='home'></main>
	<script type='module'>
		import { UI } from './ui.js';

		const main = document.getElementById( 'home' );
		const ui = new UI( { rootElement: main, topicPrefix: 'home', sendMessageFunction: sendMessage } );

		// MQTT.

		const BEST_EFFORT   = 0;
		const AT_LEAST_ONCE = 1;
		const EXACTLY_ONCE  = 2;

		function onConnect( ) {
			console.log( 'connected' );
			client.subscribe( 'home/#' );
			console.log( 'done setup' );
		}

		function onConnectionLost( message ) {
			console.log( `connection lost: ${message.errorMessage}` );
		}
		function onConnectionFailure( message ) {
			console.log( `connection failed: ${message.errorMessage}` );
		}

		function onMessageArrived( message ) {
			const topic = message.destinationName;
			const data = message.payloadString;
			console.log( `${topic}: ${data}` );

			try {
				ui.set( topic, data );
			} catch ( e ) {
				console.error( `error when displaying ${topic}=${data}: ${e}` );
			}
		}
		function sendMessage( path, data ) {
			const message = new Paho.Message( data );
			message.destinationName = path;
			message.qos = AT_LEAST_ONCE;
			message.retained = true;

			client.send( message );
		}

		const client = new Paho.Client( 'valkyrie.local', 1884, `web-client_${Math.floor(Math.random()*10000)}` );
		client.onMessageArrived = onMessageArrived;
		client.onConnectionLost = onConnectionLost;
		// TODO: also { useSSL: true, userName: …, password: … }.
		// https://www.eclipse.org/paho/files/jsdoc/
		client.connect( { onSuccess: onConnect, onFailure: onConnectionFailure, reconnect: true } );
	</script>
</body>
</html>
