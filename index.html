<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>home</title>
	<style>
@media (prefers-color-scheme: dark) {
        body {
                background: #1f1f1f;
                color: #ddd;
        }
	input, button {
		display: block;
	}
}
	</style>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js' type='text/javascript'></script>
</head>

<body>
	<h1>edelheim</h2>

	<script type='module'>
		String.prototype.toTitleCase = function() {
			return this.split( ' ' )
				   .map( word => `${word.charAt( 0 ).toUpperCase()}${word.slice( 1 )}` )
			           .join( ' ' );
		}

		const BEST_EFFORT = 0;
		const AT_LEAST_ONCE = 1;
		const EXACTLY_ONCE = 2;

		function onConnect() {
			console.log( 'connected' );
			client.subscribe( 'home/#' );
			console.log( 'done setup' );
		}

		function onConnectionLost( message ) {
			console.log( `connection lost: ${message.errorMessage}` );
		}
		function onConnectionFailure( message ) {
			console.log( `connection failed: ${message.errorMessage}` );
		}

		function onMessageArrived( message ) {
			const topic = message.destinationName;
			const data = message.payloadString;
			console.log( `${topic}: ${data}` );

			let element = document.getElementById( topic );

			if ( ! element ) {
				const [ _home, roomID, deviceID, control ] = topic.split( '/' );
				let room = document.getElementById( roomID );
				if ( ! room ) {
					room = document.createElement( 'section' );
					room.id = roomID;
					const h2 = document.createElement( 'h2' );
					h2.textContent = roomID.replace( '-', ' ' ).toTitleCase();
					room.appendChild( h2 );
					document.body.appendChild( room );
				}
				let device = document.getElementById( deviceID );
				if ( ! device ) {
					device = document.createElement( 'section' );
					device.id = deviceID;
					const h3 = document.createElement( 'h3' );
					h3.textContent = deviceID.replace( '-', ' ' ).toTitleCase();
					device.appendChild( h3 );
					room.append( device );
				}
				if ( control === 'power' ) {
					const checkbox = document.createElement( 'input' );
					checkbox.id = topic;
					checkbox.type = 'checkbox';
					checkbox.checked = data === 'on';
					checkbox.addEventListener( 'change', e => {
						const data = e.target.checked ? 'on' : 'off';
						sendMessage( e.target.id, data );
					} );
					const label = document.createElement( 'label' );
					label.for = topic;
					label.textContent = 'Power';
					device.append( label );
					device.append( checkbox );
					element = checkbox;
				} else if ( control.endsWith( '_percent' ) ) {
					const slider = document.createElement( 'input' );
					slider.id = topic;
					slider.type = 'range';
					slider.min = 0;
					slider.max = 100;
					slider.value = data;
					slider.addEventListener( 'change', e => {
						sendMessage( e.target.id, slider.value );
					} );
					const label = document.createElement( 'label' );
					label.for = topic;
					label.textContent = control.split( '_' )[ 0 ];
					device.appendChild( label );
					device.appendChild( slider );
					element = slider;
				} else if ( control.endsWith( '_degrees' ) ) {
					const slider = document.createElement( 'input' );
					slider.id = topic;
					slider.type = 'range';
					slider.min = 0;
					slider.max = 359;
					slider.value = data;
					slider.addEventListener( 'change', e => {
						sendMessage( e.target.id, slider.value );
					} );
					const label = document.createElement( 'label' );
					label.for = topic;
					label.textContent = control.split( '_' )[ 0 ];
					device.appendChild( label );
					device.appendChild( slider );
					element = slider;
				} else if ( control === 'kelvin' ) {
					const slider = document.createElement( 'input' );
					slider.id = topic;
					slider.type = 'range';
					slider.min = 2500;
					slider.max = 9000;
					slider.value = data;
					slider.addEventListener( 'change', e => {
						sendMessage( e.target.id, slider.value );
					} );
					const label = document.createElement( 'label' );
					label.for = topic;
					label.textContent = control.split( '_' )[ 0 ];
					device.appendChild( label );
					device.appendChild( slider );
					element = slider;
				} else {
					return;
				}
			}

			element.dataset.state = data;
		}

		function sendMessage( path, data ) {
			const message = new Paho.MQTT.Message( data );
			message.destinationName = path;
			message.qos = AT_LEAST_ONCE;
			message.retained = true;
			client.send( message );
		}

		const client = new Paho.MQTT.Client( 'valkyrie.local', 1884, 'web_client' );
		client.onMessageArrived = onMessageArrived;
		client.onConnectionLost = onConnectionLost;
		// TODO: also { useSSL: true, userName: …, password: … }.
		// https://www.eclipse.org/paho/files/jsdoc/
		client.connect( { onSuccess: onConnect, onFailure: onConnectionFailure } );
	</script>
</body>
</html>
