<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>home</title>
	<style>
	@media (prefers-color-scheme: dark) {
		body {
			background: #1f1f1f;
			color: #ddd;
		}
		input, button {
			display: block;
		}
	}
	</style>
</head>
<body>
	<h1>edelheim</h1>
	<main></main>
	<script type='module'>
		import { elemRegister } from './elems.js';
	  	elemRegister( '_', null, 'button', 'div', 'input', 'h2', 'h3', 'label', 'main', 'p', 'section' );

                String.prototype.toTitleCase = function() {
                        return this.split( ' ' )
                                   .map( word => `${word.charAt( 0 ).toUpperCase()}${word.slice( 1 )}` )
                                   .join( ' ' );
                }
                Array.prototype.last = function() {
                        return this[ this.length - 1 ];
                }
                Array.prototype.unique = function() {
			return this.filter( ( x, i ) => this.indexOf( x ) === i );
                }
		Map.prototype.sortedKeys = function() {
			const keys = Array.from( this.keys() );
			keys.sort();
			return keys;
		}

                function render( m ) {
			const nameForID = id => id.split( '/' ).last().replace( '-', ' ' );

			const rooms    = ( m, home  )  => m.sortedKeys().filter( k => k.startsWith( home   ) ).map( k => k.split( '/' )[ 1 ] ).unique();
	 		const devices  = ( m, room )   => m.sortedKeys().filter( k => k.startsWith( room   ) ).map( k => k.split( '/' )[ 2 ] ).unique();
			const controls = ( m, device ) => m.sortedKeys().filter( k => k.startsWith( device ) ).map( k => k.split( '/' )[ 3 ] ).unique();

			const _power = id => _div(
				_label(
					{ for: id },
					'power',
				),
				_input(
					{ id: id },
					{ type: 'checkbox' },
					{ checked: m.get( id ) === 'on' ? true : null },
					{ change: e => sendMessage( e.target.id, e.target.checked ? 'on' : 'off' ) },
				),
			);
			const _range = ( id, min, max ) => _div(
				_label(
					{ for: id },
					nameForID( id ),
				),
				_input(
					{ id: id },
					{ type: 'range' },
					{ min: min },
					{ max: max },
					{ value: m.get( id ) },
					{ change: e => sendMessage( e.target.id, e.target.value ) },
				),
			);
			const _percent = id => _range( id, 0,    100  );
			const _degrees = id => _range( id, 0,    359  );
			const _kelvin  = id => _range( id, 2500, 9000 );
			const _text = id => _div(
				_label(
					{ for: id },
					nameForID( id ),
				),
				_input(
					{ id: id },
					{ type: 'text' },
					{ value: m.get( id ) },
				),
			);
			const _control = id =>
				id.endsWith( '_degrees' ) ? _degrees( id ) :
				id.endsWith( '_kelvin' )  ? _kelvin( id )  :
				id.endsWith( '_percent' ) ? _percent( id ) :
				id.endsWith( 'power' )    ? _power( id )   :
							    text( id )     ;

			const _device = id => _section(
				{ id: id },
				_h3( nameForID( id ) ),
				controls( m, id ).map( control => _control( `${id}/${control}` ) ),
			);
			const _room = id => _section(
				{ id: id },
				_h2( nameForID( id ) ),
				devices( m, id ).map( device => _device( `${id}/${device}` ) ),
			);
			const main = _main(
				rooms( m, 'home' ).map( room => _room( `home/${room}` ) ),
			);

			document.querySelector( 'main' ).replaceWith( main );
                }

                function sendMessage( path, data ) {
			console.log( `sent a message: ${path}: ${data}` );
                }

		// TEST DATA.

                const m = new Map();

		m.set( 'home/living-room/speakers/power',          'on' );
		m.set( 'home/living-room/speakers/volume_percent', '80' );

		function setValue( key, value ) {
			if ( m.has( key ) ) {
				const control = document.getElementById( key );
				if ( key.endsWith( '/power' ) ) {
					control.checked = value === 'on' ? 'true' : null;
				} else {
					control.value = value;
				}
			} else {
				const rerender = ! m.has( key );
				m.set( key, value );
				if ( rerender ) {
					render( m );
				}
			}
		}

		render( m );

		document.querySelector( 'body' ).appendChild(
			_button(
				'add lights',
				{ click: e => setValue( 'home/living-room/lights/power', 'on' ) },
			)
		);
		document.querySelector( 'body' ).appendChild(
			_button(
				'off lights',
				{ click: e => setValue( 'home/living-room/lights/power', 'off' ) },
			)
		);
	</script>
</body>
</html>
